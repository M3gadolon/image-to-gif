<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Image to GIF</title>

<style>
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  background: #f5f5f5;
  font-family: -apple-system, BlinkMacSystemFont,
    "Segoe UI", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
}

.main {
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: flex-start;
}

.container {
  width: 100%;
  max-width: 480px;
  padding: 24px 16px 40px;
  text-align: center;
}

h1 {
  margin: 16px 0 24px;
  font-size: 22px;
}

#dropzone {
  width: 100%;
  padding: 40px 16px;
  background: #fff;
  border: 3px dashed #bbb;
  border-radius: 12px;
  cursor: pointer;
  transition: border-color .2s;
}

#dropzone:hover,
#dropzone.drag {
  border-color: #555;
}

#status {
  margin-top: 16px;
  font-size: 14px;
}

#preview img {
  display: block;
  width: 100%;
  margin-top: 20px;
  border-radius: 8px;
}

button {
  margin-top: 20px;
  padding: 12px 24px;
  font-size: 16px;
  border: none;
  border-radius: 8px;
  background: #333;
  color: #fff;
  cursor: pointer;
}
</style>
</head>

<body>

<div class="main">
  <div class="container">

    <h1>Image → GIF</h1>

    <div id="dropzone">
      画像をドラッグ＆ドロップ<br>
      またはクリックして選択
    </div>

    <input type="file" id="fileInput" multiple accept="image/*" hidden>

    <div id="status"></div>
    <div id="preview"></div>
    <button id="downloadBtn" style="display:none;">ダウンロード</button>

  </div>
</div>

<!-- ===== JS ===== -->
<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.10.1/dist/ffmpeg.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const { createFFmpeg, fetchFile } = FFmpeg;
  const ffmpeg = createFFmpeg({ log: false });

  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('fileInput');
  const statusEl = document.getElementById('status');
  const previewEl = document.getElementById('preview');
  const downloadBtn = document.getElementById('downloadBtn');

  let gifURL = null;

  dropzone.onclick = () => fileInput.click();

  dropzone.ondragover = e => {
    e.preventDefault();
    dropzone.classList.add('drag');
  };

  dropzone.ondragleave = () => dropzone.classList.remove('drag');

  dropzone.ondrop = e => {
    e.preventDefault();
    dropzone.classList.remove('drag');
    handleFiles(e.dataTransfer.files);
  };

  fileInput.onchange = () => handleFiles(fileInput.files);

  async function handleFiles(files) {
    if (!files.length) return;

    statusEl.textContent = '処理準備中…';
    previewEl.innerHTML = '';
    downloadBtn.style.display = 'none';

    if (!ffmpeg.isLoaded()) {
      await ffmpeg.load();
    }

    statusEl.textContent = 'GIF生成中…';

    for (let i = 0; i < files.length; i++) {
      ffmpeg.FS('writeFile', `img${i}.png`, await fetchFile(files[i]));
    }

    await ffmpeg.run(
      '-framerate', '5',
      '-i', 'img%d.png',
      'output.gif'
    );

    const data = ffmpeg.FS('readFile', 'output.gif');
    const blob = new Blob([data.buffer], { type: 'image/gif' });
    gifURL = URL.createObjectURL(blob);

    const img = document.createElement('img');
    img.src = gifURL;
    previewEl.appendChild(img);

    statusEl.textContent = '完了';
    downloadBtn.style.display = 'inline-block';

    downloadBtn.onclick = () => {
      const a = document.createElement('a');
      a.href = gifURL;
      a.download = 'converted.gif';
      a.click();
    };
  }
});
</script>

<link rel="icon" href="data:,">
</body>
</html>
