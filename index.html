<script type="module">
import { FFmpeg } from "https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/esm/index.js";
import { fetchFile } from "https://unpkg.com/@ffmpeg/util@0.12.1/dist/esm/index.js";

const dropzone = document.getElementById('dropzone');
const fileInput = document.getElementById('fileInput');
const statusEl = document.getElementById('status');
const previewEl = document.getElementById('preview');
const downloadBtn = document.getElementById('downloadBtn');

const ffmpeg = new FFmpeg();
let gifURL = null;

async function loadFFmpeg() {
  if (!ffmpeg.loaded) {
    statusEl.textContent = 'FFmpegを読み込み中…';
    await ffmpeg.load({
      coreURL: "https://unpkg.com/@ffmpeg/core@0.12.6/dist/esm/ffmpeg-core.js"
    });
  }
}

fileInput.addEventListener('change', () => {
  handleFiles(fileInput.files);
});

dropzone.addEventListener('dragover', e => {
  e.preventDefault();
  dropzone.classList.add('hover');
});
dropzone.addEventListener('dragleave', () => {
  dropzone.classList.remove('hover');
});
dropzone.addEventListener('drop', e => {
  e.preventDefault();
  dropzone.classList.remove('hover');
  handleFiles(e.dataTransfer.files);
});

async function handleFiles(files) {
  if (!files || files.length === 0) return;

  await loadFFmpeg();
  statusEl.textContent = 'GIFを生成中…';

  // 既存データ初期化
  previewEl.innerHTML = '';
  gifURL && URL.revokeObjectURL(gifURL);

  // 画像を書き込み
  for (let i = 0; i < files.length; i++) {
    const name = `img${i}.png`;
    await ffmpeg.writeFile(name, await fetchFile(files[i]));
  }

  // GIF生成
  await ffmpeg.exec([
    '-framerate', '5',
    '-i', 'img%d.png',
    '-vf', 'scale=400:-1',
    'output.gif'
  ]);

  const gifData = await ffmpeg.readFile('output.gif');
  const blob = new Blob([gifData.buffer], { type: 'image/gif' });
  gifURL = URL.createObjectURL(blob);

  // プレビュー表示
  const img = document.createElement('img');
  img.src = gifURL;
  img.style.maxWidth = '100%';
  previewEl.appendChild(img);

  statusEl.textContent = '変換完了';
  downloadBtn.style.display = 'inline-block';

  downloadBtn.onclick = () => {
    const a = document.createElement('a');
    a.href = gifURL;
    a.download = 'converted.gif';
    a.click();
  };
}
</script>
