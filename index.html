<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Image to GIF</title>

<style>
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 0;
  background: #f5f5f5;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
               "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
  text-align: center;
}

h1 {
  margin: 24px 0;
  font-size: 22px;
}

#container {
  max-width: 480px;
  margin: 0 auto;
  padding: 0 16px;
}

#dropzone {
  display: block;
  width: 100%;
  padding: 40px 20px;
  background: #fff;
  border: 3px dashed #bbb;
  border-radius: 10px;
  cursor: pointer;
  transition: 0.2s;
}

#dropzone:hover,
#dropzone.hover {
  border-color: #666;
}

#status {
  margin-top: 16px;
  font-size: 14px;
}

#preview img {
  max-width: 100%;
  margin-top: 20px;
  border-radius: 8px;
}

button {
  margin-top: 20px;
  padding: 12px 24px;
  font-size: 16px;
  border: none;
  border-radius: 8px;
  background: #333;
  color: #fff;
  cursor: pointer;
}

button:hover {
  opacity: 0.85;
}
</style>
</head>

<body>

<h1>Image → GIF</h1>

<div id="container">
  <label id="dropzone">
    画像をドラッグ＆ドロップ<br>
    またはクリックして選択
    <input type="file" id="fileInput" multiple accept="image/*" hidden>
  </label>

  <div id="status"></div>
  <div id="preview"></div>
  <button id="downloadBtn" style="display:none;">ダウンロード</button>
</div>

<!-- ================= JS ================= -->
<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.10.1/dist/ffmpeg.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const { createFFmpeg, fetchFile } = FFmpeg;
  const ffmpeg = createFFmpeg({ log: false });

  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('fileInput');
  const statusEl = document.getElementById('status');
  const previewEl = document.getElementById('preview');
  const downloadBtn = document.getElementById('downloadBtn');

  let gifURL = null;

  dropzone.onclick = () => fileInput.click();

  dropzone.ondragover = e => {
    e.preventDefault();
    dropzone.classList.add('hover');
  };

  dropzone.ondragleave = () => dropzone.classList.remove('hover');

  dropzone.ondrop = e => {
    e.preventDefault();
    dropzone.classList.remove('hover');
    handleFiles(e.dataTransfer.files);
  };

  fileInput.onchange = () => handleFiles(fileInput.files);

  async function handleFiles(files) {
    if (!files.length) return;

    statusEl.textContent = 'FFmpeg 読み込み中…';
    previewEl.innerHTML = '';
    downloadBtn.style.display = 'none';

    if (!ffmpeg.isLoaded()) {
      await ffmpeg.load();
    }

    statusEl.textContent = 'GIF 生成中…';

    for (let i = 0; i < files.length; i++) {
      ffmpeg.FS('writeFile', `img${i}.png`, await fetchFile(files[i]));
    }

    await ffmpeg.run(
      '-framerate', '5',
      '-i', 'img%d.png',
      'output.gif'
    );

    const data = ffmpeg.FS('readFile', 'output.gif');
    const blob = new Blob([data.buffer], { type: 'image/gif' });
    gifURL = URL.createObjectURL(blob);

    const img = document.createElement('img');
    img.src = gifURL;
    previewEl.appendChild(img);

    statusEl.textContent = '完了';
    downloadBtn.style.display = 'inline-block';

    downloadBtn.onclick = () => {
      const a = document.createElement('a');
      a.href = gifURL;
      a.download = 'converted.gif';
      a.click();
    };
  }
});
</script>

<link rel="icon" href="data:,">
</body>
</html>
